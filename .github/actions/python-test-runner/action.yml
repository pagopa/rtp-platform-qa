name: Python test runner
description: Setup Python, install extras, run tests, and upload allure-results artifact
inputs:
  extras:
    description: pyproject extras group to install (e.g. functional-tests)
    required: true
  run_cmd:
    description: Command to run tests that outputs to allure-results
    required: true
  artifact_name:
    description: Name of the artifact to upload (e.g. allure-results-functional)
    required: true
  extra_install:
    description: Optional extra installation shell commands (e.g. playwright install)
    required: false
    default: ''
runs:
  using: composite
  steps:
    - name: Setup Python
      uses: actions/setup-python@f677139bbe7f9c59b41e40162b753c062f5d49a3 # v5.2.0
      with:
        python-version: 3.x
    - name: Install dependencies
      shell: bash
      run: |
        set -euo pipefail
        EXTRAS="${{ inputs.extras }}"
        if [[ -z "$EXTRAS" || ! "$EXTRAS" =~ ^[A-Za-z0-9._,-]+$ ]]; then
          echo "Invalid extras value: '$EXTRAS'"; exit 1
        fi
        python -m pip install --upgrade pip
        pip install -e ".[${EXTRAS}]"
    - name: Extra install
      if: ${{ inputs.extra_install != '' }}
      shell: bash
      run: |
        set -euo pipefail
        bash -lc "${{ inputs.extra_install }}"
    - name: Run tests
      shell: bash
      continue-on-error: true
      run: ${{ inputs.run_cmd }}
    - name: Upload allure results
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: ${{ inputs.artifact_name }}
        path: allure-results
