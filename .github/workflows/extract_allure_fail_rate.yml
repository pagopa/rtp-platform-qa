name: Extract Fail Rate from Allure

on:
  workflow_call:
    inputs:
      THRESHOLD:
        required: true
        type: number

jobs:
  ExtractFailRate:
    runs-on: ubuntu-latest
    outputs:
      FAIL_RATE: ${{ env.FAIL_RATE }}
      SEND_NOTIFICATION: ${{ env.SEND_NOTIFICATION }}
      SUCCESS_RATE: ${{ env.SUCCESS_RATE }}
      LATEST_FOLDER: ${{ env.LATEST_FOLDER }}
    steps:
      - name: Clone gh-pages branch into a temporary directory
        if: always()
        continue-on-error: true
        run: |
          git clone --branch gh-pages --depth 1 https://github.com/pagopa/${{ github.event.repository.name }}.git temp-gh-pages
          echo "Cloned gh-pages branch into temp-gh-pages directory."
      - name: Find Latest Run Directory
        if: always()
        continue-on-error: true
        id: find_latest_run
        run: |
          latest_dir=$(ls -d temp-gh-pages/*/ | grep -E '/[0-9]+/$' | sort -V | tail -n 1)
          echo "Latest directory: $latest_dir"
          echo "latest_dir=$latest_dir" >> $GITHUB_OUTPUT
      - name: Extract Fail Rate from Allure
        shell: bash
        run: |
          set -euo pipefail
          ROOT="temp-gh-pages"
          SUM=""
          FOLDER="aggregate"

          if [ -f "${ROOT}/aggregate/widgets/summary.json" ]; then
            SUM="${ROOT}/aggregate/widgets/summary.json"
            FOLDER="aggregate"
          else
            for sub in functional bdd ux contract; do
              if [ -f "${ROOT}/${sub}/widgets/summary.json" ]; then
                SUM="${ROOT}/${sub}/widgets/summary.json"
                FOLDER="$sub"
                break
              fi
            done
          fi

          if [ -z "$SUM" ]; then
            latest_dir=$(ls -d ${ROOT}/*/ 2>/dev/null | grep -E '/[0-9]+/$' | sort -V | tail -n 1 || true)
            if [ -n "$latest_dir" ] && [ -f "${latest_dir}/widgets/summary.json" ]; then
              SUM="${latest_dir}/widgets/summary.json"
              FOLDER="$(basename "$latest_dir")"
            fi
          fi

          if [ -z "$SUM" ]; then
            echo "No Allure summary found."
            echo "FAIL_RATE=0" >> $GITHUB_ENV
            echo "SUCCESS_RATE=0.00" >> $GITHUB_ENV
            echo "SEND_NOTIFICATION=false" >> $GITHUB_ENV
            echo "LATEST_FOLDER=" >> $GITHUB_ENV
            exit 0
          fi

          passed=$(jq -r '.statistic.passed // 0' "$SUM")
          total=$(jq -r  '.statistic.total  // 0' "$SUM")

          if [ "$total" -le 0 ]; then
            success_rate="0.00"
          else
            success_rate=$(awk -v p="$passed" -v t="$total" 'BEGIN{printf("%.2f",(p/t)*100)}')
          fi

          fail_rate_number=$(awk -v s="$success_rate" 'BEGIN{printf("%.0f", 100 - s)}')
          send_notification=$([ "$fail_rate_number" -gt ${{ inputs.THRESHOLD }} ] && echo true || echo false)

          echo "FAIL_RATE=$fail_rate_number"   >> $GITHUB_ENV
          echo "SUCCESS_RATE=$success_rate"    >> $GITHUB_ENV
          echo "SEND_NOTIFICATION=$send_notification" >> $GITHUB_ENV
          echo "LATEST_FOLDER=$FOLDER"         >> $GITHUB_ENV

  SendSlackNotification:
    needs: ExtractFailRate
    uses: ./.github/workflows/send_slack_notification.yml
    if: always()
    with:
      FAIL_RATE: ${{ needs.ExtractFailRate.outputs.FAIL_RATE }}
      SUCCESS_RATE: ${{ needs.ExtractFailRate.outputs.SUCCESS_RATE }}
      SEND_NOTIFICATION: ${{ needs.ExtractFailRate.outputs.SEND_NOTIFICATION }}
      LATEST_FOLDER: ${{ needs.ExtractFailRate.outputs.LATEST_FOLDER }}
    secrets: inherit
