name: Extract Fail Rate from Allure

on:
  workflow_call:
    inputs:
      THRESHOLD:
        required: true
        type: number

jobs:
  ExtractFailRate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      FAIL_RATE: ${{ env.FAIL_RATE }}
      SEND_NOTIFICATION: ${{ env.SEND_NOTIFICATION }}
      SUCCESS_RATE: ${{ env.SUCCESS_RATE }}
      LATEST_FOLDER: ${{ env.LATEST_FOLDER }}
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938 # v4.2.0
        with:
          ref: gh-pages
          path: gh-pages

      - name: Compute rates from Allure (aggregate preferred)
        shell: bash
        run: |
          set -euo pipefail
          ROOT="gh-pages"
          SUM=""
          FOLDER="aggregate"

          if [[ -f "${ROOT}/aggregate/widgets/summary.json" ]]; then
            SUM="${ROOT}/aggregate/widgets/summary.json"
          else
            for sub in functional bdd ux contract; do
              if [[ -f "${ROOT}/${sub}/widgets/summary.json" ]]; then
                SUM="${ROOT}/${sub}/widgets/summary.json"
                FOLDER="$sub"
                break
              fi
            done
          fi

          if [[ -z "${SUM}" ]]; then
            echo "No Allure summary found under gh-pages."
            echo "FAIL_RATE=0" >> $GITHUB_ENV
            echo "SUCCESS_RATE=0.00" >> $GITHUB_ENV
            echo "SEND_NOTIFICATION=false" >> $GITHUB_ENV
            echo "LATEST_FOLDER=" >> $GITHUB_ENV
            exit 0
          fi

          passed=$(jq -r '.statistic.passed // 0' "$SUM")
          failed=$(jq -r '.statistic.failed // 0' "$SUM")
          broken=$(jq -r '.statistic.broken // 0' "$SUM")
          total=$(jq -r '.statistic.total  // 0' "$SUM")

          if [[ "$total" -le 0 ]]; then
            success_rate="0.00"
            fail_rate="0"
          else
            success_rate=$(awk -v p="$passed" -v t="$total" 'BEGIN{printf("%.2f",(p/t)*100)}')
            fail_rate=$(awk -v f="$failed" -v b="$broken" -v t="$total" 'BEGIN{printf("%.0f", ((f+b)/t)*100)}')
          fi

          echo "SUCCESS_RATE=$success_rate" >> $GITHUB_ENV
          echo "FAIL_RATE=$fail_rate" >> $GITHUB_ENV
          echo "LATEST_FOLDER=$FOLDER" >> $GITHUB_ENV
          if [[ "$fail_rate" -gt "${{ inputs.THRESHOLD }}" ]]; then
            echo "SEND_NOTIFICATION=true" >> $GITHUB_ENV
          else
            echo "SEND_NOTIFICATION=false" >> $GITHUB_ENV
          fi

  SendSlackNotification:
    needs: ExtractFailRate
    uses: ./.github/workflows/send_slack_notification.yml
    if: always()
    with:
      FAIL_RATE: ${{ needs.ExtractFailRate.outputs.FAIL_RATE }}
      SUCCESS_RATE: ${{ needs.ExtractFailRate.outputs.SUCCESS_RATE }}
      SEND_NOTIFICATION: ${{ needs.ExtractFailRate.outputs.SEND_NOTIFICATION }}
      LATEST_FOLDER: ${{ needs.ExtractFailRate.outputs.LATEST_FOLDER }}
    secrets: inherit
